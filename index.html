<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bit√°cora de Pr√©stamo de Equipos ‚Äî FIM</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #f5f6fa;
    color: #2d3436;
    font-family: 'Roboto', sans-serif;
    font-size: 15px;
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: #2c3e50;
    color: white;
    padding: 0 1.5rem;
    height: 60px;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  .logo-block .inst {
    font-weight: 700;
    font-size: 1.1rem;
    color: #f39c12;
  }
  .logo-block .sub {
    font-size: 0.65rem;
    color: #b2bec3;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .header-sep { width: 1px; height: 32px; background: #4a5568; }

  .page-title {
    font-size: 0.95rem;
    font-weight: 500;
    color: #dfe6e9;
  }

  .header-right { margin-left: auto; display: flex; gap: 0.6rem; }

  .stat-pill {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 4px;
    padding: 0.25rem 0.7rem;
    font-size: 0.78rem;
    color: #dfe6e9;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .dot { width: 7px; height: 7px; border-radius: 50%; }
  .dot-green  { background: #00b894; }
  .dot-yellow { background: #f39c12; }

  /* LAYOUT */
  .container { max-width: 1300px; margin: 0 auto; padding: 1.5rem; }

  /* TABS */
  .tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #dfe6e9;
  }

  .tab {
    padding: 0.55rem 1.2rem;
    border: none;
    background: transparent;
    color: #636e72;
    font-family: 'Roboto', sans-serif;
    font-size: 0.88rem;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.15s;
  }
  .tab.active { color: #2980b9; border-bottom-color: #2980b9; }
  .tab:not(.active):hover { color: #2d3436; background: #f0f0f0; border-radius: 4px 4px 0 0; }

  /* PANELS */
  .panel { display: none; }
  .panel.active { display: block; }

  /* CARDS */
  .card {
    background: white;
    border: 1px solid #dfe6e9;
    border-radius: 6px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  }

  .card h2 {
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 1.25rem;
    padding-bottom: 0.6rem;
    border-bottom: 2px solid #f39c12;
    display: inline-block;
  }

  /* FORM */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .form-group { display: flex; flex-direction: column; gap: 0.3rem; }

  .form-group label {
    font-size: 0.8rem;
    font-weight: 500;
    color: #636e72;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    background: #fff;
    border: 1px solid #b2bec3;
    border-radius: 4px;
    color: #2d3436;
    font-family: 'Roboto', sans-serif;
    font-size: 0.88rem;
    padding: 0.55rem 0.8rem;
    transition: border-color 0.15s;
    outline: none;
  }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: #2980b9;
    box-shadow: 0 0 0 2px rgba(41,128,185,0.1);
  }
  .form-group textarea { resize: vertical; min-height: 75px; }

  .form-row { grid-column: 1/-1; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }

  .checkbox-group { display: flex; gap: 1.2rem; }
  .checkbox-group label {
    display: flex; align-items: center; gap: 0.4rem;
    font-size: 0.88rem; color: #2d3436; cursor: pointer; font-weight: 400;
  }
  .checkbox-group input { accent-color: #2980b9; width: 15px; height: 15px; padding: 0; }

  /* BUTTONS */
  .btn {
    padding: 0.5rem 1.2rem;
    border-radius: 4px;
    border: 1px solid transparent;
    font-family: 'Roboto', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-primary { background: #2980b9; color: white; border-color: #2980b9; }
  .btn-primary:hover { background: #1f6fa0; border-color: #1f6fa0; }

  .btn-outline { background: white; border-color: #b2bec3; color: #636e72; }
  .btn-outline:hover { border-color: #2980b9; color: #2980b9; }

  .btn-success { background: transparent; border-color: #00b894; color: #00b894; padding: 0.35rem 0.75rem; font-size: 0.8rem; }
  .btn-success:hover { background: #00b894; color: white; }

  .btn-danger { background: transparent; border-color: #e17055; color: #e17055; padding: 0.35rem 0.75rem; font-size: 0.8rem; }
  .btn-danger:hover { background: #e17055; color: white; }

  .btn-info { background: transparent; border-color: #0984e3; color: #0984e3; padding: 0.35rem 0.75rem; font-size: 0.8rem; }
  .btn-info:hover { background: #0984e3; color: white; }

  /* STATS GRID */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-card {
    background: white;
    border: 1px solid #dfe6e9;
    border-left: 4px solid #ccc;
    border-radius: 6px;
    padding: 1rem 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .stat-card.gold  { border-left-color: #f39c12; }
  .stat-card.green { border-left-color: #00b894; }
  .stat-card.red   { border-left-color: #e17055; }
  .stat-card.blue  { border-left-color: #0984e3; }

  .stat-card .label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #636e72;
    font-weight: 500;
    margin-bottom: 0.35rem;
  }
  .stat-card .value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
  }
  .stat-card.gold .value  { color: #f39c12; }
  .stat-card.green .value { color: #00b894; }
  .stat-card.red .value   { color: #e17055; }
  .stat-card.blue .value  { color: #0984e3; }

  /* FILTERS */
  .filters {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 1rem;
  }

  .search-box { flex: 1; min-width: 220px; position: relative; }
  .search-box input {
    width: 100%;
    background: white;
    border: 1px solid #b2bec3;
    border-radius: 4px;
    color: #2d3436;
    font-family: 'Roboto', sans-serif;
    font-size: 0.88rem;
    padding: 0.5rem 0.8rem 0.5rem 2.2rem;
    outline: none;
    transition: border-color 0.15s;
  }
  .search-box input:focus { border-color: #2980b9; }
  .search-box .icon { position: absolute; left: 0.7rem; top: 50%; transform: translateY(-50%); color: #b2bec3; font-size: 0.85rem; }

  .filter-select {
    background: white;
    border: 1px solid #b2bec3;
    border-radius: 4px;
    color: #2d3436;
    font-family: 'Roboto', sans-serif;
    font-size: 0.85rem;
    padding: 0.5rem 0.8rem;
    outline: none;
    cursor: pointer;
  }
  .filter-select:focus { border-color: #2980b9; }

  /* TABLE */
  .table-wrap {
    background: white;
    border: 1px solid #dfe6e9;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  }

  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }

  thead { background: #f8f9fa; }
  thead th {
    padding: 0.75rem 1rem;
    text-align: left;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #636e72;
    font-weight: 600;
    border-bottom: 1px solid #dfe6e9;
    white-space: nowrap;
  }

  tbody tr { border-bottom: 1px solid #f0f0f0; transition: background 0.1s; }
  tbody tr:hover { background: #f8f9fa; }
  tbody tr:last-child { border-bottom: none; }

  td { padding: 0.75rem 1rem; vertical-align: middle; }
  td.mono { font-family: 'Roboto Mono', monospace; font-size: 0.78rem; color: #636e72; }

  /* BADGES */
  .badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 3px;
    font-size: 0.72rem;
    font-weight: 600;
  }
  .badge-active   { background: #ffeaa7; color: #856404; }
  .badge-returned { background: #d4edda; color: #155724; }
  .badge-late     { background: #f8d7da; color: #721c24; }

  /* EMPTY STATE */
  .empty { text-align: center; padding: 2.5rem; color: #b2bec3; }
  .empty .big { font-size: 2rem; margin-bottom: 0.4rem; }
  .empty p { font-size: 0.85rem; }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 200;
    justify-content: center;
    align-items: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: white;
    border-radius: 6px;
    padding: 1.75rem;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  }

  .modal h3 {
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #dfe6e9;
  }

  .modal-details { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.25rem; }

  .detail-row { display: flex; gap: 0.75rem; padding: 0.4rem 0; border-bottom: 1px solid #f5f5f5; }
  .detail-row:last-child { border-bottom: none; }
  .detail-row .dlabel { font-size: 0.75rem; color: #636e72; font-weight: 500; width: 130px; flex-shrink: 0; }
  .detail-row .dval   { font-size: 0.88rem; }

  .modal-actions { display: flex; gap: 0.6rem; justify-content: flex-end; flex-wrap: wrap; padding-top: 1rem; border-top: 1px solid #f0f0f0; }

  /* TOAST */
  #toast {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    background: #2c3e50;
    color: white;
    border-radius: 4px;
    padding: 0.75rem 1.1rem;
    font-size: 0.85rem;
    transform: translateY(60px);
    opacity: 0;
    transition: all 0.25s ease;
    z-index: 300;
    max-width: 280px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  #toast.show { transform: translateY(0); opacity: 1; }

  @media (max-width: 640px) {
    header { height: auto; padding: 0.75rem; flex-wrap: wrap; }
    .container { padding: 1rem; }
    .form-grid { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .table-wrap { overflow-x: auto; }
  }
</style>
</head>
<body>

<header>
  <div class="logo-block">
    <div class="inst">FIM ‚Äî UAS</div>
    <div class="sub">Facultad de Ingenier√≠a Mochis</div>
  </div>
  <div class="header-sep"></div>
  <span class="page-title">Bit√°cora de Pr√©stamo de Equipos</span>
  <div class="header-right">
    <div class="stat-pill"><div class="dot dot-green"></div><span id="hdr-activos">0 activos</span></div>
    <div class="stat-pill"><div class="dot dot-yellow"></div><span id="hdr-hoy">0 hoy</span></div>
  </div>
</header>

<div class="container">

  <div class="tabs">
    <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
    <button class="tab" onclick="showTab('nuevo')">‚ûï Nuevo Pr√©stamo</button>
    <button class="tab" onclick="showTab('activos')">üì¶ Activos</button>
    <button class="tab" onclick="showTab('historial')">üìã Historial</button>
    <button class="tab" onclick="showTab('equipos')">üñ•Ô∏è Equipos</button>
  </div>

  <!-- DASHBOARD -->
  <div id="panel-dashboard" class="panel active">
    <div class="stats-grid">
      <div class="stat-card gold"><div class="label">Total Registros</div><div class="value" id="stat-total">0</div></div>
      <div class="stat-card gold"><div class="label">Pr√©stamos Activos</div><div class="value" id="stat-activos">0</div></div>
      <div class="stat-card green"><div class="label">Devueltos</div><div class="value" id="stat-devueltos">0</div></div>
      <div class="stat-card red"><div class="label">Con Retraso</div><div class="value" id="stat-retraso">0</div></div>
      <div class="stat-card blue"><div class="label">Prestados Hoy</div><div class="value" id="stat-hoy">0</div></div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Nombre</th><th>Carrera / Grupo</th><th>Equipo</th><th>Fecha</th><th>Tipo</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody id="dash-table-body"><tr><td colspan="8"><div class="empty"><div class="big">üìã</div><p>Sin registros recientes</p></div></td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- NUEVO -->
  <div id="panel-nuevo" class="panel">
    <div class="card">
      <h2>Registrar Nuevo Pr√©stamo</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>Nombre completo *</label>
          <input type="text" id="f-nombre" placeholder="Apellidos y nombre">
        </div>
        <div class="form-group">
          <label>Carrera *</label>
          <select id="f-carrera">
            <option value="">‚Äî Seleccionar ‚Äî</option>
            <option>Ingenier√≠a en Sistemas Computacionales</option>
            <option>Ingenier√≠a Industrial</option>
            <option>Ingenier√≠a Civil</option>
            <option>Ingenier√≠a Qu√≠mica</option>
            <option>Ingenier√≠a Mecatr√≥nica</option>
            <option>Ingenier√≠a El√©ctrica</option>
            <option>Otra</option>
          </select>
        </div>
        <div class="form-group">
          <label>Grupo *</label>
          <input type="text" id="f-grupo" placeholder="Ej. 5A, 3B‚Ä¶">
        </div>
        <div class="form-group">
          <label>Semestre</label>
          <select id="f-semestre">
            <option value="">‚Äî ‚Äî</option>
            <option>1¬∞</option><option>2¬∞</option><option>3¬∞</option><option>4¬∞</option>
            <option>5¬∞</option><option>6¬∞</option><option>7¬∞</option><option>8¬∞</option><option>9¬∞</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tipo de usuario *</label>
          <div class="checkbox-group">
            <label><input type="radio" name="tipo-usuario" value="Alumno" checked> Alumno</label>
            <label><input type="radio" name="tipo-usuario" value="Profesor"> Profesor</label>
          </div>
        </div>
        <div class="form-group">
          <label>N¬∞ de cuenta / Matr√≠cula</label>
          <input type="text" id="f-matricula" placeholder="N√∫mero de identificaci√≥n">
        </div>
        <div class="form-group" style="grid-column:1/-1">
          <label>Equipo a prestar *</label>
          <select id="f-equipo"><option value="">‚Äî Seleccionar equipo ‚Äî</option></select>
        </div>
        <div class="form-group">
          <label>Fecha de pr√©stamo *</label>
          <input type="date" id="f-fecha-prestamo">
        </div>
        <div class="form-group">
          <label>Hora de pr√©stamo *</label>
          <input type="time" id="f-hora-prestamo">
        </div>
        <div class="form-group">
          <label>Fecha de entrega estimada</label>
          <input type="date" id="f-fecha-entrega">
        </div>
        <div class="form-group">
          <label>Hora de entrega estimada</label>
          <input type="time" id="f-hora-entrega">
        </div>
        <div class="form-group" style="grid-column:1/-1">
          <label>Observaciones</label>
          <textarea id="f-obs" placeholder="Estado del equipo, accesorios incluidos, notas especiales‚Ä¶"></textarea>
        </div>
        <div class="form-row">
          <label style="font-size:0.8rem;color:#636e72;font-weight:500;white-space:nowrap">Firma del encargado:</label>
          <input type="text" id="f-firma-prestador" placeholder="Nombre del encargado"
            style="flex:1;border:1px solid #b2bec3;border-radius:4px;padding:0.55rem 0.8rem;font-family:'Roboto',sans-serif;font-size:0.88rem;outline:none;">
        </div>
        <div class="form-row" style="justify-content:flex-end;padding-top:0.25rem">
          <button class="btn btn-outline" onclick="limpiarForm()">Limpiar</button>
          <button class="btn btn-primary" onclick="registrarPrestamo()">üì• Registrar Pr√©stamo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ACTIVOS -->
  <div id="panel-activos" class="panel">
    <div class="filters">
      <div class="search-box">
        <span class="icon">üîç</span>
        <input type="text" id="search-activos" placeholder="Buscar por nombre, equipo, grupo‚Ä¶" oninput="renderActivos()">
      </div>
      <select class="filter-select" id="filter-carrera-a" onchange="renderActivos()">
        <option value="">Todas las carreras</option>
      </select>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Nombre</th><th>Carrera</th><th>Grupo</th><th>Tipo</th><th>Equipo</th><th>Fecha Pr√©stamo</th><th>Entrega Est.</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody id="activos-table-body"><tr><td colspan="10"><div class="empty"><div class="big">‚úÖ</div><p>Sin pr√©stamos activos</p></div></td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div id="panel-historial" class="panel">
    <div class="filters">
      <div class="search-box">
        <span class="icon">üîç</span>
        <input type="text" id="search-hist" placeholder="Buscar en historial‚Ä¶" oninput="renderHistorial()">
      </div>
      <select class="filter-select" id="filter-estado-h" onchange="renderHistorial()">
        <option value="">Todos los estados</option>
        <option value="Activo">Activo</option>
        <option value="Devuelto">Devuelto</option>
        <option value="Retraso">Con retraso</option>
      </select>
      <button class="btn btn-outline" onclick="exportarCSV()">‚¨áÔ∏è Exportar CSV</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Nombre</th><th>Carrera / Grupo</th><th>Tipo</th><th>Equipo</th><th>Fecha Pr√©stamo</th><th>Fecha Devoluci√≥n</th><th>Estado</th><th>Encargado</th><th>Acciones</th></tr></thead>
        <tbody id="hist-table-body"><tr><td colspan="10"><div class="empty"><div class="big">üìã</div><p>Sin registros</p></div></td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- EQUIPOS -->
  <div id="panel-equipos" class="panel">
    <div class="card">
      <h2>Gesti√≥n de Equipos</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>Nombre / Descripci√≥n *</label>
          <input type="text" id="eq-nombre" placeholder="Ej. Laptop HP 14, Proyector Epson‚Ä¶">
        </div>
        <div class="form-group">
          <label>N¬∞ de serie / Inventario</label>
          <input type="text" id="eq-serie" placeholder="N√∫mero de inventario">
        </div>
        <div class="form-group">
          <label>Categor√≠a</label>
          <select id="eq-cat">
            <option value="">‚Äî ‚Äî</option>
            <option>Laptop</option><option>Proyector</option>
            <option>Cable HDMI</option><option>C√°mara</option>
            <option>Tablet</option><option>Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label>Estado f√≠sico</label>
          <select id="eq-estado">
            <option>Bueno</option><option>Regular</option><option>Deteriorado</option>
          </select>
        </div>
        <div class="form-row" style="justify-content:flex-end">
          <button class="btn btn-primary" onclick="agregarEquipo()">‚ûï Agregar Equipo</button>
        </div>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Equipo</th><th>N¬∞ Serie</th><th>Categor√≠a</th><th>Estado</th><th>Disponibilidad</th><th>Acciones</th></tr></thead>
        <tbody id="eq-table-body"><tr><td colspan="7"><div class="empty"><div class="big">üñ•Ô∏è</div><p>Sin equipos registrados</p></div></td></tr></tbody>
      </table>
    </div>
  </div>

</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h3 id="modal-title">Detalle del Pr√©stamo</h3>
    <div class="modal-details" id="modal-body"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </div>
</div>

<div id="toast"></div>

<script>
let prestamos = JSON.parse(localStorage.getItem('fim_prestamos') || '[]');
let equipos   = JSON.parse(localStorage.getItem('fim_equipos')   || '[]');
let modalTarget = null;

document.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  document.getElementById('f-fecha-prestamo').value = now.toISOString().split('T')[0];
  document.getElementById('f-hora-prestamo').value  = now.toTimeString().slice(0,5);
  if (equipos.length === 0) {
    equipos = [
      { id:'E001', nombre:'Laptop HP 14 ‚Äî #001',        serie:'HP-001',    cat:'Laptop',     estado:'Bueno', disponible:true },
      { id:'E002', nombre:'Proyector Epson S41+ ‚Äî #001', serie:'EP-S41-01', cat:'Proyector',  estado:'Bueno', disponible:true },
      { id:'E003', nombre:'Cable HDMI 3m ‚Äî #001',        serie:'HDMI-001',  cat:'Cable HDMI', estado:'Bueno', disponible:true },
    ];
    saveEquipos();
  }
  renderAll(); populateEquiposSelect(); populateCarreraFilters();
});

function saveAll()    { localStorage.setItem('fim_prestamos', JSON.stringify(prestamos)); saveEquipos(); }
function saveEquipos(){ localStorage.setItem('fim_equipos',   JSON.stringify(equipos)); }

function showTab(id) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  event.target.classList.add('active');
  renderAll();
}

function renderAll() {
  renderDashboard(); renderActivos(); renderHistorial();
  renderEquipos(); updateHeaderStats(); populateCarreraFilters();
}

function renderDashboard() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('stat-total').textContent     = prestamos.length;
  document.getElementById('stat-activos').textContent   = prestamos.filter(p=>p.estado==='Activo').length;
  document.getElementById('stat-devueltos').textContent = prestamos.filter(p=>p.estado==='Devuelto').length;
  document.getElementById('stat-retraso').textContent   = prestamos.filter(p=>p.estado==='Activo'&&p.fechaEntrega&&p.fechaEntrega<today).length;
  document.getElementById('stat-hoy').textContent       = prestamos.filter(p=>p.fechaPrestamo===today).length;
  const recent = [...prestamos].reverse().slice(0,10);
  document.getElementById('dash-table-body').innerHTML = recent.length
    ? recent.map(p=>`<tr>
        <td class="mono">${String(p.id).padStart(4,'0')}</td>
        <td><strong>${p.nombre}</strong></td>
        <td>${(p.carrera||'').split(' ').slice(-1)[0]||'‚Äî'} / ${p.grupo||'‚Äî'}</td>
        <td>${p.equipo}</td>
        <td class="mono">${p.fechaPrestamo}</td>
        <td>${p.tipoUsuario}</td>
        <td>${badgeEstado(p)}</td>
        <td><button class="btn btn-info" onclick="openModal(${p.id})">Ver</button></td>
      </tr>`).join('')
    : '<tr><td colspan="8"><div class="empty"><div class="big">üìã</div><p>Sin registros recientes</p></div></td></tr>';
}

function renderActivos() {
  const q=document.getElementById('search-activos')?.value.toLowerCase()||'';
  const carr=document.getElementById('filter-carrera-a')?.value||'';
  const today=new Date().toISOString().split('T')[0];
  const data=prestamos.filter(p=>p.estado==='Activo'
    &&(!q||[p.nombre,p.equipo,p.grupo,p.carrera].join(' ').toLowerCase().includes(q))
    &&(!carr||p.carrera===carr));
  document.getElementById('activos-table-body').innerHTML = data.length
    ? data.map(p=>{ const late=p.fechaEntrega&&p.fechaEntrega<today; return `<tr>
        <td class="mono">${String(p.id).padStart(4,'0')}</td>
        <td><strong>${p.nombre}</strong><br><small style="color:#636e72">${p.matricula||''}</small></td>
        <td style="font-size:0.82rem">${p.carrera||'‚Äî'}</td>
        <td>${p.grupo||'‚Äî'}</td><td>${p.tipoUsuario}</td><td>${p.equipo}</td>
        <td class="mono">${p.fechaPrestamo} ${p.horaPrestamo}</td>
        <td class="mono" style="color:${late?'#e17055':'inherit'}">${p.fechaEntrega||'‚Äî'} ${p.horaEntrega||''}</td>
        <td>${late?'<span class="badge badge-late">‚ö† Retraso</span>':'<span class="badge badge-active">Activo</span>'}</td>
        <td style="display:flex;gap:0.4rem;flex-wrap:wrap">
          <button class="btn btn-success" onclick="devolverPrestamo(${p.id})">‚Ü© Devolver</button>
          <button class="btn btn-info" onclick="openModal(${p.id})">Ver</button>
        </td></tr>`; }).join('')
    : '<tr><td colspan="10"><div class="empty"><div class="big">‚úÖ</div><p>Sin pr√©stamos activos</p></div></td></tr>';
}

function renderHistorial() {
  const q=document.getElementById('search-hist')?.value.toLowerCase()||'';
  const est=document.getElementById('filter-estado-h')?.value||'';
  const today=new Date().toISOString().split('T')[0];
  const data=[...prestamos].reverse().filter(p=>{
    const match=!q||[p.nombre,p.equipo,p.grupo,p.carrera].join(' ').toLowerCase().includes(q);
    let em=true;
    if(est==='Activo') em=p.estado==='Activo'&&(!p.fechaEntrega||p.fechaEntrega>=today);
    if(est==='Devuelto') em=p.estado==='Devuelto';
    if(est==='Retraso') em=p.estado==='Activo'&&p.fechaEntrega&&p.fechaEntrega<today;
    return match&&em;
  });
  document.getElementById('hist-table-body').innerHTML = data.length
    ? data.map(p=>`<tr>
        <td class="mono">${String(p.id).padStart(4,'0')}</td>
        <td>${p.nombre}</td>
        <td style="font-size:0.82rem">${(p.carrera||'').split(' ').slice(-1)[0]||'‚Äî'} / ${p.grupo||'‚Äî'}</td>
        <td>${p.tipoUsuario}</td><td>${p.equipo}</td>
        <td class="mono">${p.fechaPrestamo} ${p.horaPrestamo}</td>
        <td class="mono">${p.fechaDevolucion?p.fechaDevolucion+' '+(p.horaDevolucion||''):'‚Äî'}</td>
        <td>${badgeEstado(p)}</td>
        <td style="font-size:0.82rem">${p.firmaPrestador||'‚Äî'}</td>
        <td style="display:flex;gap:0.4rem">
          <button class="btn btn-info" onclick="openModal(${p.id})">Ver</button>
          ${p.estado==='Activo'?`<button class="btn btn-success" onclick="devolverPrestamo(${p.id})">‚Ü©</button>`:''}
        </td></tr>`).join('')
    : '<tr><td colspan="10"><div class="empty"><div class="big">üìã</div><p>Sin registros</p></div></td></tr>';
}

function renderEquipos() {
  document.getElementById('eq-table-body').innerHTML = equipos.length
    ? equipos.map(e=>`<tr>
        <td class="mono">${e.id}</td><td>${e.nombre}</td>
        <td class="mono">${e.serie||'‚Äî'}</td><td>${e.cat||'‚Äî'}</td><td>${e.estado}</td>
        <td>${e.disponible?'<span class="badge badge-returned">Disponible</span>':'<span class="badge badge-active">En pr√©stamo</span>'}</td>
        <td><button class="btn btn-danger" onclick="eliminarEquipo(\'${e.id}\')">üóë</button></td>
      </tr>`).join('')
    : '<tr><td colspan="7"><div class="empty"><div class="big">üñ•Ô∏è</div><p>Sin equipos registrados</p></div></td></tr>';
}

function agregarEquipo() {
  const nombre=document.getElementById('eq-nombre').value.trim();
  if(!nombre){showToast('‚ö†Ô∏è Ingresa el nombre del equipo');return;}
  const id='E'+String(equipos.length+1).padStart(3,'0');
  equipos.push({id,nombre,serie:document.getElementById('eq-serie').value.trim(),
    cat:document.getElementById('eq-cat').value,estado:document.getElementById('eq-estado').value,disponible:true});
  saveEquipos();
  document.getElementById('eq-nombre').value='';
  document.getElementById('eq-serie').value='';
  populateEquiposSelect();renderEquipos();showToast('‚úÖ Equipo agregado');
}

function eliminarEquipo(id){
  if(!confirm('¬øEliminar este equipo?'))return;
  equipos=equipos.filter(e=>e.id!==id);
  saveEquipos();populateEquiposSelect();renderEquipos();showToast('üóëÔ∏è Equipo eliminado');
}

function populateEquiposSelect(){
  const sel=document.getElementById('f-equipo');
  sel.innerHTML='<option value="">‚Äî Seleccionar equipo ‚Äî</option>';
  equipos.filter(e=>e.disponible).forEach(e=>{
    sel.innerHTML+=`<option value="${e.nombre} (${e.id})">${e.nombre} (${e.id})</option>`;
  });
}

function registrarPrestamo(){
  const nombre=document.getElementById('f-nombre').value.trim();
  const carrera=document.getElementById('f-carrera').value;
  const grupo=document.getElementById('f-grupo').value.trim();
  const equipo=document.getElementById('f-equipo').value;
  const fechaPrestamo=document.getElementById('f-fecha-prestamo').value;
  const horaPrestamo=document.getElementById('f-hora-prestamo').value;
  const tipoUsuario=document.querySelector('input[name="tipo-usuario"]:checked')?.value||'Alumno';
  if(!nombre||!carrera||!grupo||!equipo||!fechaPrestamo){showToast('‚ö†Ô∏è Completa los campos obligatorios (*)');return;}
  const id=prestamos.length?Math.max(...prestamos.map(p=>p.id))+1:1;
  const eqId=equipo.match(/\(([^)]+)\)/)?.[1];
  if(eqId){const eq=equipos.find(e=>e.id===eqId);if(eq)eq.disponible=false;saveEquipos();}
  prestamos.push({id,nombre,carrera,grupo,
    semestre:document.getElementById('f-semestre').value,
    matricula:document.getElementById('f-matricula').value.trim(),
    tipoUsuario,equipo,eqId:eqId||null,fechaPrestamo,horaPrestamo,
    fechaEntrega:document.getElementById('f-fecha-entrega').value,
    horaEntrega:document.getElementById('f-hora-entrega').value,
    obs:document.getElementById('f-obs').value.trim(),
    firmaPrestador:document.getElementById('f-firma-prestador').value.trim(),
    estado:'Activo',fechaDevolucion:null,horaDevolucion:null});
  saveAll();limpiarForm();populateEquiposSelect();renderAll();
  showToast(`‚úÖ Pr√©stamo registrado para ${nombre}`);
}

function devolverPrestamo(id){
  const p=prestamos.find(x=>x.id===id);if(!p)return;
  const now=new Date();
  p.estado='Devuelto';
  p.fechaDevolucion=now.toISOString().split('T')[0];
  p.horaDevolucion=now.toTimeString().slice(0,5);
  if(p.eqId){const eq=equipos.find(e=>e.id===p.eqId);if(eq)eq.disponible=true;saveEquipos();}
  saveAll();populateEquiposSelect();renderAll();closeModal();
  showToast(`‚Ü© Equipo devuelto ‚Äî ${p.equipo}`);
}

function openModal(id){
  const p=prestamos.find(x=>x.id===id);if(!p)return;
  modalTarget=p.id;
  const today=new Date().toISOString().split('T')[0];
  const late=p.estado==='Activo'&&p.fechaEntrega&&p.fechaEntrega<today;
  document.getElementById('modal-title').textContent=`Pr√©stamo #${String(p.id).padStart(4,'0')}`;
  document.getElementById('modal-body').innerHTML=[
    row('Nombre',`<strong>${p.nombre}</strong>`),
    row('Carrera',p.carrera||'‚Äî'),
    row('Grupo / Semestre',`${p.grupo||'‚Äî'} / ${p.semestre||'‚Äî'}`),
    row('Matr√≠cula',p.matricula||'‚Äî'),
    row('Tipo',p.tipoUsuario),
    row('Equipo',p.equipo),
    row('Fecha pr√©stamo',`${p.fechaPrestamo} ${p.horaPrestamo}`),
    row('Entrega estimada',p.fechaEntrega?`${p.fechaEntrega} ${p.horaEntrega}`:'‚Äî'),
    row('Estado',badgeEstado(p)+(late?' <span style="color:#e17055;font-size:0.78rem">‚ö† Fuera de tiempo</span>':'')),
    p.estado==='Devuelto'?row('Fecha devoluci√≥n',`${p.fechaDevolucion} ${p.horaDevolucion}`):'',
    row('Encargado',p.firmaPrestador||'‚Äî'),
    p.obs?row('Observaciones',p.obs):'',
  ].join('');
  document.getElementById('modal-actions').innerHTML=
    (p.estado==='Activo'?`<button class="btn btn-success" onclick="devolverPrestamo(${p.id})">‚Ü© Registrar Devoluci√≥n</button>`:'')
    +`<button class="btn btn-outline" onclick="closeModal()">Cerrar</button>`;
  document.getElementById('modal-overlay').classList.add('open');
}

function row(label,val){return `<div class="detail-row"><span class="dlabel">${label}</span><span class="dval">${val}</span></div>`;}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open');modalTarget=null;}
document.getElementById('modal-overlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal();});

function badgeEstado(p){
  const today=new Date().toISOString().split('T')[0];
  if(p.estado==='Devuelto')return'<span class="badge badge-returned">Devuelto</span>';
  if(p.fechaEntrega&&p.fechaEntrega<today)return'<span class="badge badge-late">Retraso</span>';
  return'<span class="badge badge-active">Activo</span>';
}

function updateHeaderStats(){
  const activos=prestamos.filter(p=>p.estado==='Activo').length;
  const today=new Date().toISOString().split('T')[0];
  const hoy=prestamos.filter(p=>p.fechaPrestamo===today).length;
  document.getElementById('hdr-activos').textContent=`${activos} activos`;
  document.getElementById('hdr-hoy').textContent=`${hoy} hoy`;
}

function populateCarreraFilters(){
  const carreras=[...new Set(prestamos.map(p=>p.carrera).filter(Boolean))];
  const sel=document.getElementById('filter-carrera-a');if(!sel)return;
  const cur=sel.value;
  sel.innerHTML='<option value="">Todas las carreras</option>';
  carreras.forEach(c=>sel.innerHTML+=`<option value="${c}"${c===cur?' selected':''}>${c}</option>`);
}

function limpiarForm(){
  ['f-nombre','f-grupo','f-matricula','f-obs','f-firma-prestador','f-fecha-entrega','f-hora-entrega'].forEach(id=>{
    document.getElementById(id).value='';
  });
  document.getElementById('f-carrera').value='';
  document.getElementById('f-semestre').value='';
  document.getElementById('f-equipo').value='';
  document.querySelector('input[name="tipo-usuario"][value="Alumno"]').checked=true;
  const now=new Date();
  document.getElementById('f-fecha-prestamo').value=now.toISOString().split('T')[0];
  document.getElementById('f-hora-prestamo').value=now.toTimeString().slice(0,5);
}

function exportarCSV(){
  const headers=['ID','Nombre','Carrera','Grupo','Semestre','Matr√≠cula','Tipo','Equipo',
    'Fecha Pr√©stamo','Hora','Fecha Entrega Est.','Estado','Fecha Devoluci√≥n','Encargado','Observaciones'];
  const rows=prestamos.map(p=>[p.id,p.nombre,p.carrera,p.grupo,p.semestre,p.matricula,
    p.tipoUsuario,p.equipo,p.fechaPrestamo,p.horaPrestamo,p.fechaEntrega,p.estado,
    p.fechaDevolucion||'',p.firmaPrestador,p.obs].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv=[headers.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`prestamos_FIM_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();showToast('‚¨áÔ∏è CSV exportado');
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}
</script>
</body>
</html>
